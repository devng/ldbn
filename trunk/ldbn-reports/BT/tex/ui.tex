\section{Server Clients}
\label{sec:ui}

In this section we go over the different clients and describe their functionality in correlation
with their user interfaces (UI), so that the reader can better grasp the concept of each client and the role of the
back-end server. 

The most important part of a system for end users and critical for its system success is
the UI. Therefore we put a lot of our efforts in developing a fast,
intuitive and stable UI for both clients for our server - the ELBS viewer and the download portal. 


\subsection{ELBS Viewer}
\label{sec:elbsviewer}
In this section we present our improvements to the ELBS viewer.

\subsubsection{E-Book Navigation}
Figure~\ref{fig:elbs11mw} shows the main window of the new improved version 1.1 of the ELBS viewer. 
The first thing the reader might notice is the fact that ELBS 1.1 has a new navigation pane on the left-hand side,
as opposed to ELBS 1.0, which is shown in Figure~\ref{fig:elbs10}.

The pane contains small preview images (thumbnails) of all the pages of a book. 
By clicking on a thumbnail, a new is page is requested from the server and then loaded in the viewer. 
The new navigation pane has two advantages. 
On the one hand, users can find pages easier, which means that the quantity of the full sized images, sent to the client, is diminished.
This, on the other hand, implies that we reduce the network traffic
between the server and the client. The navigation pane is similar to the ones found in 
popular PDF viewers, such as the Adobe Acrobat Reader~\cite{waar}. This is done intentionally,
in order to make our program more user-friendly and intuitive, as 
most people today are familiar with the Adobe's product. 

\begin{figure}[htb]
	\begin{center}
		\includegraphics[width=0.85\textwidth]{./img/elbs11mw}
		\caption{ELBS E-Book Viewer Version 1.1}
		\label{fig:elbs11mw}
	\end{center}
\end{figure} 

It should be noted that in our implementation, thumbnails are stored on the server and are
sent to the client upon an HTTP request. In addition, once created, they do not change over time.
 Therefore, they are generated only once in the
process of creating an E-Book, avoiding any additional overhead.
Furthermore, all thumbnails are
stored in a single file.
A diagram of the corresponding file format is illustrated in 
Figure~\ref{fig:thumbnails-format}. This concept is similar to Image Maps and 
CSS Sprites~\cite[Chapter 1]{bookhpws}. 
Sending images in a single file has the benefit that an application needs
to make fewer HTTP requests, thus reducing the response time,
because there is much less HTTP overhead~\cite[Chapter 1]{bookhpws}.  

ELBS 1.1 also supports bookmarks, i.e., chapters and sections of an E-Book 
can be mapped to a particular page. Figure~\ref{fig:elbs11mw2} illustrates an example of
bookmarks representation in the navigation pane. 
Bookmarks are stored on the server as a simple text file, an example of which
is shown in Listing~\ref{listing:bookmarks}. This file is optional and can 
be provided, using the
Administrator UI of the download portal, which is described in more detail in Section~\ref{sec:uidp}.

\subsubsection{Printing and Saving Pages}
The most significant extension of ELBS is the integrated user 
ability to log-in and print or download parts of a book. This means that users are still able to
view the whole book in the viewer. However, now they can also print pages or save them locally as PDF files. 
In order for a user to log-in, he has to click on the \emph{Print Pages} button 
(\includegraphics[scale=0.5]{./img/but/printer.png})
or on the \emph{Save Pages as PDF} button (\includegraphics[scale=0.5]{./img/but/page_save.png}). Then 
a dialog windows pops up and prompts the user to enter his credentials, i.e., user name and password. 
The window is shown in Figure~\ref{fig:login-form}. Note that users can use  their university 
accounts. For users outside the university 
an ELBS account can be created from the Administrator UI of the download portal, which is discussed
in Section~\ref{sec:uidp}. We go over the log-in procedure in
more detail in Section~\ref{sec:authentication}.

\begin{figure}[htp]
	\begin{center}
		\includegraphics[width=0.45\textwidth]{./img/login-form.png}
		\caption{ELBS Log-in Dialog}
		\label{fig:login-form}
	\end{center}
\end{figure} 

After the user has logged-in successfully, a modal pop-up window with copy right law remarks 
is shown. 
An illustration of this can be seen in Figure~\ref{fig:hinweis}, where it is also visible that this window can be actively closed from the 
After that
a \emph{Print/Download Dialog} is immediately presented, which helps users choose pages for
printing or downloading as PDF. It should be noted that we present the same dialog for both of these functions,
which differ only in the type of request to the server. 
Furthermore, the dialog also implements the model view controller pattern and supports two different types of views.
The first type is a table view, where a thumbnail for each page is
displayed in a separate row, with additional information in each column, 
such as how many times a page has been printed/downloaded. This is illustrated in Figure~\ref{fig:elbsdd0}.
In the second type of view, thumbnails are aligned in a grid, as shown in 
Figure~\ref{fig:elbsdd1}. It offerers a more compact overview of all the pages. The user can 
change between the different views form the buttons in the upper left corner of the dialog. It should be noted
that both views rely on the same data model, and are therefore always synchronized.  

\begin{figure}[htb]
  \centering
  \subfigure[Table View]{
    \includegraphics[scale=0.26]{./img/download_dialog1.png}
    \label{fig:elbsdd0}
  }
  \subfigure[Grid View]{
    \includegraphics[scale=0.27]{./img/download_dialog2.png}
    \label{fig:elbsdd1}
  }
\caption{ELBS Print/Download Dialog}
\end{figure}

In both views there is a checkbox next to each thumbnail. A user can select a page for printing/downloading by
checking that checkbox. This action will
also cause the status bar of the download dialog to change. The status bar is shown in Figure~\ref{fig:progress-green}.
The idea behind it is to offer an overview of the number of all printed/downloaded pages, including
the number of selected
for printing/downloading pages. Thus the status bar shows a percentage preview of the printed/downloaded 
portion of the book. The purpose of the status bar
is to notify the user whenever he tries to exceed the allowed print/download quota for a book. Usually that  
quota is 75\%. In such a case the status bar chages its color from green to red and the user is not allowed to 
print/download. This is illustrated in Figure~\ref{fig:progress-red}. 
However, since the ELBS system is client-server based, 
we also always check on the server-side whether or not the quota has not already been exceeded.
This implies that the progress bar is used only for user convenience.
This fact notwithstanding, the bar is important,
in order to make our program more intuitive and user-friendly.
Another feature that contributes to the user-friendliness of the ELBS viewer is the
\emph{Cart} (\includegraphics[scale=0.5]{./img/but/cart.png}) button, which
is available after a successful log-in. By pressing the button a user adds the page, that is 
currently viewed in ELBS, 
for printing/downloading, thus the checkbox for that page in the dialog gets checked. The approach is similar to
adding a product to a cart in popular online shops. Internally, the button only alters the book model, which is
described in the next section.

\begin{figure}[htb]
  \centering
  \subfigure[Print Quota Not Exceeded]{
    \includegraphics[scale=0.45]{./img/progress-green.png}
    \label{fig:progress-green}
  }
  \subfigure[Print Quota Exceeded]{
    \includegraphics[scale=0.45]{./img/progress-red.png}
    \label{fig:progress-red}
  }
\caption{Status Bar of the Print/Download Dialog}
\end{figure}
After the user has made his selection, he can click on the \emph{OK} button of the print/dialog to request the
pages from the server. There, a watermark containing the user name is added to each of them. 
An example of such a watermark is presented in Figure~\ref{fig:watermark}. After that
the pages are
sent back to the client. However, the process of downloading pages could be time consuming, 
and therefore we offer some feedback to the user
by providing him with a
download progress dialog, which can be seen in Figure~\ref{fig:download-progress}.  
On the client-side, depending on the type of request, the pages are 
either saved as a local PDF file or sent to a printer. Internally, both types of user request are handled differently. 
On the one hand, the download request causes the server to generate a PDF file.
On the other hand, printing
requires the server to send the pages as a set of images. When the images are received by the client, they
are sent to a printer directly, i.e., without the need of additional programs such as Adobe Acrobat Reader. 
This is done by
using the \verb=QPrinter= class, which part of the Qt framework and offers platform-independent printer support.
The server needs to send images instead of PDF files, because \verb=QPrinter= 
does not support PDF printing. However, direct printing is important for the ELBS viewer, due to the fact that
we want to have full control of the whole process of printing. Relying on other tools could pose a security threat. 
The importance of this is described in Section~\ref{sec:dataprotection}. 

\begin{figure}[htp]
	\begin{center}
		\includegraphics[width=0.45\textwidth]{./img/download-progress.png}
		\caption{ELBS Download Progress Dialog}
		\label{fig:download-progress}
	\end{center}
\end{figure} 

It should be noted that both features, i.e., printing and downloading pages as PDFs,
can be disabled separately,  from the server configuration. For example, if only printing support is 
desired the download feature can be suppressed. 

\subsubsection{Under the Hood}
In this section we present some of the important classes of the ELBS client and their main purpose.
Figure~\ref{fig:mediator} illustrates a UML class diagram of those classes.
The first thing to notice is the fact that we use the mediator design pattern~\cite[Chapter 5]{bib:DesignPattern}.

\begin{figure}[htb]
	\begin{center}
		\includegraphics[width=\textwidth]{./img/mediator.pdf}
		\caption{Overview of the Most Important Classes of the ELBS Viewer 1.1}
		\label{fig:mediator}
	\end{center}
\end{figure} 

\begin{description}
\item[Mediator] In ELBS 1.0 a lot of the functionality of the program was implemented in the GUI classes.
As we started introducing new features to the system, communication between objects became 
unstructured and hard to grasp. To overcome those issues we implement the mediator design pattern.  
The mediator is an  object  that  controls  how  a  set  of  objects  interact, thus
objects no longer communicate directly with each 
other explicitly, but instead use the mediator. This results in more 
coherent logic and decreased coupling between the 
other objects~\cite[Chapter 5]{bib:DesignPattern}.

\item[ProcessDetector] We use this class
to prevent certain programs from obtaining illegal screenshots of
an E-Book page.  The class is able to detect whenever a certain Windows program is running at the 
same time as the viewer. Upon detection we notify the mediator and hide the page. This process
is done continuously in a separate Thread , in oder not to  block the GUI.  
The exact mechanism of detection we use, is described in more detail in Section~\ref{sec:procdetection}

\item[Decoder] The class is used for decrypting encrypted images, sent by the server. This is discussed 
in depth in Section~\ref{sec:dataprotection}.

\item[NetworkHandler] This class is used for the HTTP communication between server and client. It relies on
the \verb=QHttp= class, which is part of the Qt framework and provides an implementation of the HTTP 
and HTTPS protocols. Communication is done asynchronously in the background,
in a similar fashion as AJAX. Thus all request
are sent in a separate thread in order not to  block to GUI.

\item[SessionData] Instances of this class save session information. In ELBS we use two different session IDs~-
one is used for viewing pages and the other one only for requesting pages for printing/downloading. 
Session management is covered in Section~\ref{sec:authentication}. 

\item[MainWindow] This is the main GUI class of the viewer. It provides the main application window.

\item[OverlayRenderer] This class is used for rendering a page directly on the screen by using the DirectDraw 
API. We use DirectDraw in order to prevent illegal screenshots.
A more detailed discussion on this topic can be found in Section~\ref{sec:screenshots}.

\item[NavigationPane] The navigation pane of the viewer was discussed earlier in this chapter. As we mentioned previously,
we use the MVC pattern and this class acts as the controller for the two different views~-the \emph{Thumbnail View} shown
in Figure~\ref{fig:elbs11mw} and the \emph{Bookmark View} shown in Figure~\ref{fig:elbs11mw2}. The data is provided by
the \emph{Book Model}.

\item[DownloadDialog] The download dialog was also presented earlier in this chapter. It acts as a controller in the MVC
design pattern for its
two different views~- the \emph{Table View} and the \emph{Grid View}. It also holds a reference to its status bar, which can
also be interpreted as a different view for the \emph{Book Model}.  

\item[BookModel] This class acts as the model in the MVC pattern. It is used by both controllers, i.e., the
\verb=NavigationPane= and the \verb=DownloadDialog= classes. Objects of this class holds different properties
of a book, such as id of the book in the database, title, the thumbnail images for the pages, bookmarks and a list
of all pages. 

\item[Page] Objects of this class are used by the \emph{Book Model} to hold different properties of a book page, 
such as the number of the page in the database.  It also holds the property that shows if the page is currently selected for printing/downloading. Last but not least, there is a download counter, which stores the number of times the current user has printed/downloaded this page.

\end{description}

\subsection{Download Portal}
\label{sec:uidp}
In this section we describe the different functionalities of the \emph{Download Portal} (DP),
which is a Web-based application for distributing digitized documents of any kind to other parties. In addition,
with the help of the DP one can manage the users and user groups.

In the context of the DP, it is possible to define two distinct user groups,
warranting at least two different user interfaces for the DP. 
One group would include
employees of the university library (administrators), 
who upload content (documents) provided by the work-flow system WUEBDIFON. As members of the other group could be considered the
research groups and costumers, who download the provided documents from the DP.
We tried to
provide both user groups with fast and easy to use UI. 

\subsubsection{Downloading Documents}
Figure~\ref{fig:dp-home-1} shows the home page of the DP. Users can log-in to the system by using the same user name and password,
as for the ELBS viewer. This implies that both applications share the same users and user groups, but have different privileges assigned
to them. 
After a user has successfully logged-in, he can click on the \emph{Download Portal} 
link on the left-side of the page in oder to gain access
to the available for him content.
There, he is presented with an overview of all the documents that are associated with him or with the user groups of which
he is member. Figure~\ref{fig:download-2} presents an example of such an overview. 
We can determine which documents are available to a
particular user, based on the domain of the user rights, associated with him or his user groups. 
For instance, a user right with domain \emph{DP\_12345} implies
that the user can download a document with an \emph{ID~= 12345}. 
Note that a document in the DP is a ZIP file, which contains a WUEBDIFON finished project, which on the other hand usually contains
the ordered digitized pages. We should point out that the DP is not responsible for ordering the content that is available in our application. This usually involves payment and it is done by another system. The order is then passed to the WUEBDIFON work-flow system. 
After WUEBDIFON finishes a project it can be uploaded to the DP.

\subsubsection{Uploading Documents and Managing Users}
Super-users who have the privilege to upload upload documents, manage users and user groups are offered an additional menu on the left-hand side of the Web page, called \emph{Admin}, which is displayed in Figure~\ref{fig:admin-menu}.
In our implementation we determine whether to grant a user  assess to those functions, based on the 
following user right, that has to be assigned to the user or one of his groups:

\begin{center}
\begin{tabular}[h]{|l|l|l|}
  \hline
  Domain & Name & Value \\ \hline
  WEB\_SECURITY & IS\_ADMIN & 1  \\ \hline
\end{tabular}
\end{center}

\begin{figure}[h]
	\begin{center}
		\includegraphics[width=0.4\textwidth]{./img/dp/admin-menu}
		\caption{Menu for Administrators in the Download Portal}
		\label{fig:admin-menu}
	\end{center}
\end{figure} 

At this point we should mention that we do not just hide the HTML links for the \emph{Admin} menu, but use Spring Security~\cite{wspringsec-1} instead, which provides advanced authentication, authorization and other security features.
A more detailed discussion on Spring Security and how we use it in the DP can be found in Section~\ref{sec:authentication}

In the remaining portion of this section, we go over the most important
items of the \emph{Admin} menu and explain their purpose and functionalities: 

\subsubsection{Add Documents (Dokumente hinzufügen)}
With the help of this UI we can add additional documents to the DP. The UI can be seen in Figure~\ref{fig:add-doc}. The user has to specify a name and a description of the document as well as the ID of the WUEBDIFON project.
It should be noted that these attributes are usually submitted directly by WUEBDIFON. This implies that users working with WUEBDIFON can click on a dedicated button, which exports the project to the DP. Exporting a project means that WUEBDIFON must open a browser with a specific URL. There, users are required to enter their credentials, after which they are presented with our UI and all the required 
information from WUEBDIFON is entered properly into the fields. In addition to this, the UI offers a section, where administrators can
specify which users and user groups should be allowed access to the to the document. Optionally, an expiration date and a maximum number of
downloads for the document can be defined. These properties, however, are assigned to individual users and user groups and not globally to the 
document. In the case, when different expiration dates and maximum number of downloads must be assigned to different users, administrators
can use the \emph{Assign Documents (Dokumente zuordnen)} UI. 
With its help such properties can be assigned in similar fashion to already existing
documents.  

\begin{figure}[htp]
	\begin{center}
		\includegraphics[width=\textwidth]{./img/dp/add-doc-2}
		\caption{Web Form for Adding Documents in the Download Portal}
		\label{fig:add-doc}
	\end{center}
\end{figure}

After an administrator has finished working with the UI, he must submit the form to the server by clicking on the \emph{Submit (Absenden)} button. This causes our server to zip the WUEBDIFON project and store it on the local file system of our server. Thus, after this step our application does not 
depend on WUEBDIFON any more, because the document can be accessed locally at any time, until it is deleted from the \emph{Delete Documents (Dokumente löschen)} UI. We should mention that zipping large files could be a very time consuming task, therefore we disable the 
submit button and notify the user that the server is working. This prevents the user from making unnecessary requests.
Note that WUEBDIFON projects are stored on a remote server, therefore we require that server
to be accessible via Samba.
 


\subsubsection{Add ELBS Books (ELBS-Bücher hinzufügen)}
Another very important feature of the DP is its ability to assists employees of the university library (administrators) 
in the process of adding E-Books to the ELBS viewer. This is done with the help of the \emph{Add ELBS Books (ELBS-Bücher hinzufügen)} UI, which is shown in Figure~\ref{fig:add-book}. There, an administrator must specify the path of the folder, where the scanned image files of a book reside. The path can be a regular one or a Samba path. Additional properties of a book can also be provided, such as title, OPAC signature, bookmarks and free pages. The latter is a collection of pages, which 
illustrate the table of contents.
However, submitting the form to the server does not cause the immediate conversion of the book into a proper ELBS E-Book format. 
The reason for that is the fact that the conversion of a book is a very time consuming task, as it involves many subtasks, such as
scaling images down, encrypting images, creating thumbnails and making the appropriate database entries. 
Therefore, this UI only creates
a simple text file, which holds the user's input and stores it in a predefined job-folder. The actual conversion of a book is done by a separate command line application, which processes all the files in the job-folder when it is executed. The program can be run either manually or by a scheduler, such as Cron, which is a time-based job scheduler in Unix-like computer operating systems.

\begin{figure}[htp]
	\begin{center}
		\includegraphics[width=\textwidth]{./img/dp/add-book-1}
		\caption{Web Form for Adding E-Books}
		\label{fig:add-book}
	\end{center}
\end{figure}

\subsubsection{Other Important Functions of the Download Portal}
The download portal incorporates many additional important functionalities that could aid administrators in other areas as well, such as
adding new users and managing user groups. In order for our system to be accessible for users, who do not possess a university account,
we offer the \emph{Manage Users (Nutzer verwalten)} UI, which can be seen in Figure~\ref{fig:add-user}.
There, administrators can add new external users to the database, or delete them. Note that our system only offers removal of external user accounts. The UI supports the option to directly associate an external user with user groups. However, this could be achieved at a later point as well, with the help of the \emph{Manage User Groups (Nutzergruppen verwalten)} UI. The latter also offers functionalities for creating or deleting user groups, as well as managing their members. 
\newline
In conclusion, we should point out that all administrator forms are developed using GWT, which was described in Section~\ref{sec:copdp}. With its help we were able to make each UI more responsive, by checking user input on the client-side as well. For example,
we check email addresses, user names, dates, numbers, etc. with regular expressions. For security reasons we also check the input on the server-side.
 Furthermore, with the help of GWT we are able to make 
dynamic lists of users or user groups on the client UI, as shown in Figures~\ref{fig:add-doc} and~\ref{fig:add-user}.
We also rely on the AJAX approach for number of reasons, including, but not limited to, checking whenever
an administrator is trying to add a document with an WUEBDIFON-ID that already exists in the database, or to add a user that has an email already present in the DB, and others. We also utilize advanced GWT widgets, such a calender widget, which helps users choose and enter dates
more conveniently. Overall, GWT greatly simplified the process of creation of an advanced, user-friendly and feature-reach Web-UI, 
that we provide
in the download portal. 

 








